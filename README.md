# Car Rental & Fleet Management System

**Author:** Peyman Khodabandehlouei  
**Student ID:** 2104987   
**Date:** January 2026

> Note 1: The biggest challenge I faced during development of this project was loose coupling. When I was writing my domain entity codes in the first homework, I did not consider persistency, hence I faced serious challenges in third homework and final delivery. 

> Note 2: Claude AI has been used for documenting and translating my detailed instructions to codes. AI has not been used blindly, I checked and refined every single line of code generated by AI.


## Table of Contents
- [Key Features](#key-features)
- [Business Rules](#business-rules)
- [Project Structure](#project-structure)
- [Design Patterns](#design-patterns)
- [API Endpoints](#api-endpoints)
- [Domain Events](#domain-events)
- [Getting Started](#getting-started)
  - [Prerequisites](#prerequisites)
  - [Installation](#installation)
- [Complete Rental Cycle](#complete-rental-cycle)
- [Acknowledgments](#acknowledgments)


---

## Key Features
- Project dependencies are managed using Poetry (with `pyproject.toml` file) for easy installation and management.
- `Docker` and `docker-compose` are used for containerizing three main components of the application: `api`, `database`, and `rabbitmq`, so you do not need to install MongoDB and RabbitMQ locally.
- With the help of `Makefile` all necessary commands for creating, running, and accessing logs have been defined.
- `core.config` uses pydantic-settings package to securely load environment variables from `.env` file.

---

## Business Rules
1. All users including `Customers` and `Employees` must be at least 18 years old.
2. ID of all entities are created automatically and cannot be edited later.
3. `Customers` can pay for a `Reservation` only if it has been approved by an `Agent`.
4. Having an `InsuranceTier` for the `Reservation` is mandatory.
5. Total price of all `Reservations` are calculated automatically using `PricingStrategy` and cannot be modified externally.
6. For all `Reservations`, an `Invoice` is created automatically with PENDING status.

---


## Project Structure

```terminaloutput
crfms-final
├── src
│   ├── api
│   │   ├── ...
│   │   └── ...
│   ├── core
│   │   ├── ...
│   │   └── ...
│   ├── domain
│   │   ├── ...
│   │   └── ...
│   ├── schemas
│   │   ├── ...
│   │   └── ...
│   └── services
│       ├── ...
│       └── ...
├── tests
│   ├── ...
│   └── ...
├── docker-compose.yml
├── Dockerfile
├── Makefile
├── pyproject.toml
└── README.md
```
`src` directory includes five main components of CRFMS application:
- `api`: Includes `routes` and the main entry point of the application.
- `core`: It defines core components such as `database_manager`, `rabbitmq_manager`, `config`, etc.
- `domain`: This directory includes all domain entities.
- `schemas`: It defines Pydantic schemas for `api`, `database models`, `rabbitmq events`, and `enums`.
- `services`: This directory includes all business logics for API endpoints.

---

## Design Patterns
1. **Singleton Pattern**: [core.DatabaseManager](src/core/database_manager.py) and [core.RabbirMQManager](src/core/rabbitmq_manager.py) are singleton to make sure only one manager exists during the runtime for handling connection pooling and asynchronous methods.
2. **Strategy Pattern**: [PricingStrategies](src/domain/pricing/concrete_strategies.py) are developed with the strategy pattern to make it easy to add new pricing strategies in the future without changing the existing code.
3. **Factory Pattern**: [Payments](src/domain/payment) are using factory pattern to make it easy to add new payment methods in the future without changing the existing code. Currently, we have CreditCard and PayPal payment methods.
4. **Observer Pattern**: [Notification system](src/domain/notification) uses observer pattern to implement a centralized notification manager and subscribe/unsubscribe methods for notifying interested parties.
---

## API Endpoints
> Important Note: User access level is not defined in this project. For production use, we should define user access levels.

### Base URL
```http
http://localhost:8000/api/v1
```

### User Management
```http
POST /auth/register/customer       Register a new customer account.
POST /auth/register/agent          Register a new agent account.
POST /auth/register/manager        Register a new manager account.

GET /auth/customers                Get all customers.
GET /auth/employees                Get all employees.
```

### Vehicle Management
```http
POST /vehicles                      Add a new vehicl.

GET /vehicles                       Retrieve all vehicles with optional filters.
GET /vehicles/{vehicle_id}          Retrieve a specific vehicle.

PUT /vehicles/{vehicle_id}          Update vehicle information
DELETE /vehicles/{vehicle_id}       Delete a vehicle.
```

### Branch Management
```http
POST /branches                      Create a new rental branch.

GET /branches                       Retrieve all rental branches.
GET /branches/{branch_id}           Retrieve a specific branch.

PUT /branches/{branch_id}           Update branch information.
DELETE /branches/{branch_id}        Delete a branch.
```

### Insurance Tiers
```http
POST /insurance-tiers               Create a new insurance tier.

GET /insurance-tiers                Retrieve all insurance tiers.
GET /insurance-tiers/{tier_id}      Retrieve a specific insurance tier.

PUT /insurance-tiers/{tier_id}      Update insurance tier information.
DELETE /insurance-tiers/{tier_id}   Delete an insurance tier.
```

### Add-ons
```http
POST /add-ons                       Create a new rental add-on.

GET /add-ons                        Retrieve all available add-ons.
GET /add-ons/{addon_id}             Retrieve a specific add-on.

PUT /add-ons/{addon_id}             Update add-on information.
DELETE /add-ons/{addon_id}          Delete an add-on.
```

### Reservation Management
```http
POST /reservations                  Create a new vehicle reservation.

GET /reservations                   Retrieve all reservations with optional filters.
GET /reservations/{reservation_id}  Retrieve a specific reservation.

PUT /reservations/{reservation_id}  Update an existing reservation.
DELETE /reservations/{reservation_id} Cancel a reservation.
```

### Payment Processing
```http
POST /payments                      Process payment for a reservation.
```

### Rental Operations
```http
POST /rentals/pickup                Process vehicle pickup for a reservation.
POST /rentals/return                Process vehicle return.

GET /rentals/{rental_id}            Retrieve rental details.
```

### Health Check

```http
GET /health                         Check API health status.
```

---

## Domain Events
> Note: Event consumer is initialized in FastAPI startup, so monitoring can be easier with docker-compose logs.
1. **ReservationConfirmed**: When a new reservation is created 
2. **ReservationModified**: When a reservation is updated 
3. **PickupCompleted**: When a customer picks up a vehicle 
4. **ReturnCompleted**: When a customer returns a vehicle 
5. **InvoicePaid**: When payment succeeds 
6. **InvoicePaymentFailed**: When payment fails

---

## Getting Started

### Prerequisites
- Make  ```sudo apt make``` for Linux or ```brew install make``` for MacOS.
- Docker 20.10+  ```sudo apt docker``` for Linux or ```brew install docker``` for MacOS.
- Docker Compose 2.0+  ```sudo apt docker-compose``` for Linux or ```brew install docker-compose``` for MacOS.

### Installation
**1. Install dependencies**
```bash

make install
```

**2. Build Docker images**
```bash

make docker-build
```

**3. Run Docker containers**
```bash

make docker-up
```
After running the above commands, you should see the following output:
```terminaloutput
Access points:
  - API Docs:  http://localhost:8000/docs
  - API:       http://localhost:8000
  - RabbitMQ:  http://localhost:15672 (guest/guest)
  - MongoDB:   mongodb://localhost:27017
```
Please go to http://localhost:8000/docs for reading API documents and testing endpoints.

**4. Access Logs**
```bash

make docker-logs
```


**5. Cleanup Docker containers**
```bash

make docker-clean
```

---

## Complete Rental Cycle
1. `POST /auth/register/customer` to register a customer account.
2. `POST /auth/register/agent` to register an agent account.
3. `POST /branches` to create a branch.
4. `POST /vehicles` to add vehicle to fleet.
5. `POST /insurance-tiers`to create insurance options.
6. `POST /add-ons`: Create add-on services (GPS, etc.).
7. `POST /reservations` to makes reservation with ID of entities created in previous steps.


8. `PUT /reservations/{reservation_id}` to approve the reservation (update status to `approved`).


9. `POST /payments` to process payment for the reservation.
10. `POST /rentals/pickup` to pick up the vehicle (requires confirmed reservation and payment).
11. `POST /rentals/return` to return the vehicle and finalize the rental.

---

## Acknowledgments

- Course: Advanced Python For AI Applications
- Professor: Professor Binnur KURT

Dear professor, Thank you so much for this amazing course, It was a great experience for me, and you influenced my career a lot, I really appreciate it. Hope to work with you in the future. Cheers.

---
